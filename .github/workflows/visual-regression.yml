# Visual Regression Testing - UltimaMinds Landing Page
#
# Adapted from @genesis/visual-regression workflow-template.yml
# Uses Playwright (not Storycap) since this is a static landing page, not Storybook.
#
# Captures multi-viewport screenshots on every PR and compares against baseline.
# P0.47 Compliance: Visual verification before merge.

name: Visual Regression

on:
  pull_request:
    branches: [main]
    paths:
      - 'components/**'
      - 'pages/**'
      - 'assets/**'
      - 'layouts/**'
      - 'nuxt.config.ts'
      - 'tailwind.config.ts'
      - 'package.json'
      - '.github/workflows/visual-regression.yml'

  push:
    branches: [main]
    paths:
      - 'components/**'
      - 'pages/**'
      - 'assets/**'
      - 'layouts/**'

env:
  NODE_VERSION: '20'
  SCREENSHOT_DIR: docs/proofs
  SITE_URL: https://ultimaminds.ai

permissions:
  contents: read
  pull-requests: write
  statuses: write

concurrency:
  group: visual-regression-${{ github.ref }}
  cancel-in-progress: true

jobs:
  visual-regression:
    name: Playwright Visual Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Chromium
        run: npx playwright install chromium

      - name: Build SSG
        run: pnpm generate

      - name: Capture Screenshots (Local Preview)
        run: |
          # Serve the generated static site
          npx serve .output/public -l 15575 &
          SERVER_PID=$!
          npx wait-on http://localhost:15575 --timeout 30000

          # Run visual proof tests against local build
          npx playwright test tests/e2e/visual-proof.spec.ts --reporter=list

          kill $SERVER_PID || true

          echo "Screenshot count:"
          find ${{ env.SCREENSHOT_DIR }} -name "*.png" | wc -l

      - name: Upload Screenshots as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-screenshots
          path: ${{ env.SCREENSHOT_DIR }}/*.png
          retention-days: 30

      - name: Upload to Argos CI
        if: ${{ secrets.ARGOS_TOKEN != '' }}
        run: npx @argos-ci/cli upload ${{ env.SCREENSHOT_DIR }} --token ${{ secrets.ARGOS_TOKEN }}
        env:
          ARGOS_BUILD_NAME: ${{ github.ref_name }}

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Count screenshots
            const proofDir = '${{ env.SCREENSHOT_DIR }}';
            let screenshotCount = 0;
            try {
              const files = fs.readdirSync(proofDir).filter(f => f.endsWith('.png'));
              screenshotCount = files.length;
            } catch (e) {
              screenshotCount = 0;
            }

            const comment = `## Visual Regression Results

            **${screenshotCount} screenshots** captured across 3 viewports (desktop, tablet, mobile).

            | Viewport | Resolution | Sections |
            |----------|-----------|----------|
            | Desktop | 1920x1080 | 6 |
            | Tablet | 768x1024 | 6 |
            | Mobile | 390x844 | 6 |

            **Review:** Download the \`visual-regression-screenshots\` artifact to inspect changes.

            ---
            _Visual testing powered by [@genesis/playwright-config](https://github.com/okanyucel2/genesisv3) Â· P0.47 Compliance_`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Visual Regression Results')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  visual-regression-check:
    name: Visual Regression Required
    runs-on: ubuntu-latest
    needs: visual-regression
    if: github.event_name == 'pull_request'
    steps:
      - name: Visual Check Passed
        run: |
          echo "Visual regression screenshots captured and uploaded."
          echo "P0.47 Compliance: Visual verification completed."
